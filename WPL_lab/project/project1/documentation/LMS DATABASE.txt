CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,

    first_name VARCHAR(100) NOT NULL,
    last_name  VARCHAR(100) NOT NULL,

    full_name VARCHAR(201)
        GENERATED ALWAYS AS (
            CONCAT(first_name, ' ', last_name)
        ) STORED,

    email VARCHAR(255) NOT NULL UNIQUE,
    contact_number VARCHAR(20),

    password_hash VARCHAR(255) NOT NULL,
    user_code VARCHAR(255) NOT NULL UNIQUE,

    status ENUM('active','inactive','suspended')
        NOT NULL DEFAULT 'active',

    is_deleted BOOLEAN NOT NULL DEFAULT FALSE,

    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL
        DEFAULT CURRENT_TIMESTAMP
        ON UPDATE CURRENT_TIMESTAMP
);
CREATE TABLE roles (
    role_id INT AUTO_INCREMENT PRIMARY KEY,
    role_name ENUM(
        'student',
        'faculty',
        'admin',
        'student_affairs',
        'examination',
        'admission',
        'accounts'
    ) NOT NULL UNIQUE
);
CREATE TABLE user_roles (
    user_id INT NOT NULL,
    role_id INT NOT NULL,
    PRIMARY KEY (user_id, role_id),
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (role_id) REFERENCES roles(role_id)
);
CREATE TABLE faculty (
    faculty_id INT AUTO_INCREMENT PRIMARY KEY,
    faculty_name VARCHAR(100) NOT NULL,
    faculty_code VARCHAR(50) NOT NULL UNIQUE,
    faculty_status ENUM('active', 'inactive') NOT NULL DEFAULT 'active'
);
CREATE TABLE department (
    department_id INT AUTO_INCREMENT PRIMARY KEY,
    department_name VARCHAR(100) NOT NULL,
    department_code VARCHAR(50) NOT NULL UNIQUE,
    department_status ENUM('active', 'inactive') NOT NULL DEFAULT 'active',
    email VARCHAR(255) NOT NULL UNIQUE,
    contact_number VARCHAR(20) NULL,
    faculty_id INT NOT NULL,
    
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP 
        ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (faculty_id) REFERENCES faculty(faculty_id)
        ON UPDATE CASCADE
        ON DELETE RESTRICT
);
CREATE TABLE program (
    program_id INT AUTO_INCREMENT PRIMARY KEY,
    department_id INT NOT NULL,
    program_code VARCHAR(50) NOT NULL UNIQUE,
    program_name VARCHAR(100) NOT NULL,
    degree_level ENUM('diploma','bachelors','masters','phd') NOT NULL,
    duration INT NOT NULL COMMENT 'Duration in years',
    minimum_semesters INT NOT NULL,
    minimum_credit_hrs INT NOT NULL,
    program_status ENUM('active','inactive','phased_out') NOT NULL DEFAULT 'active',
    description TEXT NULL,

    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP 
        ON UPDATE CURRENT_TIMESTAMP,

    FOREIGN KEY (department_id) REFERENCES department(department_id)
        ON UPDATE CASCADE
        ON DELETE RESTRICT
);
CREATE TABLE student (
    student_id INT PRIMARY KEY,  -- same as user_id
    program_id INT NOT NULL,
    student_number VARCHAR(50) NOT NULL UNIQUE,  -- university student ID
    admission_year YEAR NOT NULL,
    current_semester INT NOT NULL DEFAULT 1,
    enrollment_status ENUM(
        'active',
        'suspended',
        'withdrawn',
        'graduated',
        'expelled',
        'on_break'
    ) NOT NULL DEFAULT 'active',
    academic_standing ENUM(
        'good',
        'probation',
        'warning',
        'honors'
    ) DEFAULT 'good',
    attempted_credit_hrs INT NOT NULL DEFAULT 0,
    completed_credit_hrs INT NOT NULL DEFAULT 0,
    remaining_credit_hrs INT NOT NULL DEFAULT 0,

    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP 
        ON UPDATE CURRENT_TIMESTAMP,

    FOREIGN KEY (student_id) REFERENCES users(id)
        ON UPDATE CASCADE
        ON DELETE CASCADE,
    FOREIGN KEY (program_id) REFERENCES program(program_id)
        ON UPDATE CASCADE
        ON DELETE RESTRICT
);
CREATE TABLE teacher (
    teacher_id INT PRIMARY KEY,  -- same as user_id
    department_id INT NOT NULL,
    program_id INT NULL,  -- optional, some teachers may not belong to a specific program
    employee_number VARCHAR(50) NOT NULL UNIQUE,
    designation ENUM(
        'lecturer',
        'assistant_professor',
        'associate_professor',
        'professor',
        'lab_assistant'
    ) NOT NULL,
    hire_date DATE NOT NULL,
    employment_status ENUM(
        'active',
        'on_leave',
        'resigned',
        'retired',
        'terminated'
    ) NOT NULL DEFAULT 'active',
    research_area VARCHAR(255) NULL,  -- optional

    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP 
        ON UPDATE CURRENT_TIMESTAMP,

    FOREIGN KEY (teacher_id) REFERENCES users(id)
        ON UPDATE CASCADE
        ON DELETE CASCADE,
    FOREIGN KEY (department_id) REFERENCES department(department_id)
        ON UPDATE CASCADE
        ON DELETE RESTRICT,
    FOREIGN KEY (program_id) REFERENCES program(program_id)
        ON UPDATE CASCADE
        ON DELETE SET NULL
);
CREATE TABLE course (
    course_id INT AUTO_INCREMENT PRIMARY KEY,
    department_id INT NOT NULL,
    course_code VARCHAR(50) NOT NULL UNIQUE,       -- e.g., CS101
    course_name VARCHAR(150) NOT NULL,
    credit_hrs INT NOT NULL,                        -- number of credit hours
    course_type ENUM('core','elective') NOT NULL,
    recommended_semester INT NULL COMMENT 'Recommended semester for the course',
    prerequisite_course_id INT NULL,               -- self-reference for prerequisites
    description TEXT NULL,

    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP 
        ON UPDATE CURRENT_TIMESTAMP,

    FOREIGN KEY (department_id) REFERENCES department(department_id)
        ON UPDATE CASCADE
        ON DELETE RESTRICT,
    FOREIGN KEY (prerequisite_course_id) REFERENCES course(course_id)
        ON UPDATE CASCADE
        ON DELETE SET NULL
);
CREATE TABLE course_offering (
    offering_id INT AUTO_INCREMENT PRIMARY KEY,
    course_id INT NOT NULL,
    academic_year VARCHAR(9) NOT NULL,             -- e.g., "2025-2026"
    semester ENUM('1','2','3','4','5','6','7','8','9','10') NOT NULL, -- actual semester
    term ENUM('Fall','Spring','Summer') NOT NULL DEFAULT 'Fall',
    max_enrollment INT NULL,                        -- optional seat limit
    location VARCHAR(100) NULL,                     -- optional classroom/lab
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
        ON UPDATE CURRENT_TIMESTAMP,

    FOREIGN KEY (course_id) REFERENCES course(course_id)
        ON UPDATE CASCADE
        ON DELETE RESTRICT,
    
    UNIQUE(course_id, academic_year, semester, term)  -- ensures no duplicate offerings
);
CREATE TABLE course_teacher (
    course_teacher_id INT AUTO_INCREMENT PRIMARY KEY,
    offering_id INT NOT NULL,
    teacher_id INT NOT NULL,
    role ENUM('instructor','co_instructor','lab_instructor','teaching_assistant') NOT NULL DEFAULT 'instructor',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
        ON UPDATE CURRENT_TIMESTAMP,

    FOREIGN KEY (offering_id) REFERENCES course_offering(offering_id)
        ON UPDATE CASCADE
        ON DELETE CASCADE,
    FOREIGN KEY (teacher_id) REFERENCES teacher(teacher_id)
        ON UPDATE CASCADE
        ON DELETE RESTRICT,

    UNIQUE(offering_id, teacher_id, role)  -- prevent duplicate role assignments
);
CREATE TABLE enrollment (
    enrollment_id INT AUTO_INCREMENT PRIMARY KEY,
    student_id INT NOT NULL,
    offering_id INT NOT NULL,
    enrollment_date DATE NOT NULL DEFAULT CURRENT_DATE,
    status ENUM('enrolled','dropped','completed','failed') NOT NULL DEFAULT 'enrolled',
    grade_point DECIMAL(3,2) NULL,  -- e.g., 4.00, 3.50
    grade CHAR(2) GENERATED ALWAYS AS (
        CASE
            WHEN grade_point >= 3.7 THEN 'A'
            WHEN grade_point >= 3.3 THEN 'A-'
            WHEN grade_point >= 3.0 THEN 'B+'
            WHEN grade_point >= 2.7 THEN 'B'
            WHEN grade_point >= 2.3 THEN 'B-'
            WHEN grade_point >= 2.0 THEN 'C+'
            WHEN grade_point >= 1.7 THEN 'C'
            WHEN grade_point >= 1.3 THEN 'C-'
            WHEN grade_point >= 1.0 THEN 'D'
            ELSE 'F'
        END
    ) STORED,
    credit_hrs INT NOT NULL,  -- copied from course_offering at enrollment time
    credit_earned INT GENERATED ALWAYS AS (
        CASE
            WHEN status = 'completed' THEN credit_hrs
            ELSE 0
        END
    ) STORED,
    
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP 
        ON UPDATE CURRENT_TIMESTAMP,

    FOREIGN KEY (student_id) REFERENCES student(student_id)
        ON UPDATE CASCADE
        ON DELETE CASCADE,
    FOREIGN KEY (offering_id) REFERENCES course_offering(offering_id)
        ON UPDATE CASCADE
        ON DELETE RESTRICT,
    
    UNIQUE(student_id, offering_id)  -- prevent duplicate enrollment
);
CREATE TABLE module (
    module_id INT AUTO_INCREMENT PRIMARY KEY,
    offering_id INT NOT NULL,   -- course_offering, not course
    module_name VARCHAR(100) NOT NULL,
    module_code VARCHAR(20) NOT NULL,
    description TEXT NULL,
    sequence_number INT NOT NULL,  -- order within course
    status ENUM('active','inactive') NOT NULL DEFAULT 'active',
    start_date DATE NULL,
    end_date DATE NULL,

    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP 
        ON UPDATE CURRENT_TIMESTAMP,

    FOREIGN KEY (offering_id) REFERENCES course_offering(offering_id)
        ON UPDATE CASCADE
        ON DELETE CASCADE,

    UNIQUE (offering_id, module_code),
    UNIQUE (offering_id, sequence_number)
);
CREATE TABLE lesson (
    lesson_id INT AUTO_INCREMENT PRIMARY KEY,
    module_id INT NOT NULL,

    lesson_title VARCHAR(150) NOT NULL,
    lesson_type ENUM('video','live','text','slides') NOT NULL,

    description TEXT NULL,
    sequence_number INT NOT NULL,

    scheduled_start DATETIME NULL,  -- ONLY for live lessons
    scheduled_end DATETIME NULL,

    status ENUM('draft','published','archived') NOT NULL DEFAULT 'draft',

    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
        ON UPDATE CURRENT_TIMESTAMP,

    FOREIGN KEY (module_id) REFERENCES module(module_id)
        ON DELETE CASCADE,

    UNIQUE (module_id, sequence_number)
);
CREATE TABLE resource (
    resource_id INT AUTO_INCREMENT PRIMARY KEY,

    resource_type ENUM('video','pdf','ppt','doc','link','image','audio') NOT NULL,
    resource_url VARCHAR(500) NOT NULL,
    resource_name VARCHAR(150) NULL,

    uploaded_by INT NULL,  -- teacher user_id
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (uploaded_by) REFERENCES users(id)
);
CREATE TABLE lesson_resource (
    lesson_id INT NOT NULL,
    resource_id INT NOT NULL,
    is_primary BOOLEAN NOT NULL DEFAULT FALSE,  -- main video/slide

    PRIMARY KEY (lesson_id, resource_id),

    FOREIGN KEY (lesson_id) REFERENCES lesson(lesson_id)
        ON DELETE CASCADE,
    FOREIGN KEY (resource_id) REFERENCES resource(resource_id)
        ON DELETE CASCADE
);
CREATE TABLE assignment (
    assignment_id INT AUTO_INCREMENT PRIMARY KEY,

    module_id INT NOT NULL,

    assignment_title VARCHAR(150) NOT NULL,
    description TEXT NULL,

    max_marks INT NOT NULL,
    weightage DECIMAL(5,2) NOT NULL,  -- percentage contribution

    due_date DATETIME NOT NULL,
    allow_late_submission BOOLEAN NOT NULL DEFAULT FALSE,
    late_penalty_percent DECIMAL(5,2) NULL,

    status ENUM('draft','published','closed') NOT NULL DEFAULT 'draft',

    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
        ON UPDATE CURRENT_TIMESTAMP,

    FOREIGN KEY (module_id) REFERENCES module(module_id)
        ON DELETE CASCADE
) ENGINE=InnoDB;
CREATE TABLE assignment_resource (
    assignment_id INT NOT NULL,
    resource_id INT NOT NULL,

    is_primary BOOLEAN NOT NULL DEFAULT FALSE,

    PRIMARY KEY (assignment_id, resource_id),

    FOREIGN KEY (assignment_id) REFERENCES assignment(assignment_id)
        ON DELETE CASCADE,
    FOREIGN KEY (resource_id) REFERENCES resource(resource_id)
        ON DELETE CASCADE
) ENGINE=InnoDB;
CREATE TABLE assignment_submission (
    submission_id INT AUTO_INCREMENT PRIMARY KEY,

    assignment_id INT NOT NULL,
    student_id INT NOT NULL,

    submitted_at DATETIME NULL,
    is_late BOOLEAN NOT NULL DEFAULT FALSE,

    marks_obtained INT NULL,
    feedback TEXT NULL,

    status ENUM('draft','submitted','graded','resubmitted') NOT NULL DEFAULT 'draft',

    graded_by INT NULL,  -- teacher user_id
    graded_at DATETIME NULL,

    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
        ON UPDATE CURRENT_TIMESTAMP,

    CONSTRAINT uq_assignment_student UNIQUE (assignment_id, student_id),

    FOREIGN KEY (assignment_id) REFERENCES assignment(assignment_id)
        ON DELETE CASCADE,

    FOREIGN KEY (student_id) REFERENCES student(student_id)
        ON DELETE CASCADE,

    FOREIGN KEY (graded_by) REFERENCES `users`(id)
        ON DELETE SET NULL
) ENGINE=InnoDB;
CREATE TABLE exam (
    exam_id INT AUTO_INCREMENT PRIMARY KEY,

    offering_id INT NOT NULL,

    exam_title VARCHAR(150) NOT NULL,
    exam_type ENUM('quiz','midterm','final','makeup','practical') NOT NULL,

    max_marks INT NOT NULL,
    weightage DECIMAL(5,2) NOT NULL,  -- % contribution to course

    exam_mode ENUM('online','physical','hybrid') NOT NULL,

    scheduled_start DATETIME NOT NULL,
    scheduled_end DATETIME NOT NULL,

    status ENUM('scheduled','ongoing','completed','cancelled') NOT NULL DEFAULT 'scheduled',

    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
        ON UPDATE CURRENT_TIMESTAMP,

    FOREIGN KEY (offering_id) REFERENCES course_offering(offering_id)
        ON DELETE CASCADE
) ENGINE=InnoDB;
CREATE TABLE exam_section (
    section_id INT AUTO_INCREMENT PRIMARY KEY,

    exam_id INT NOT NULL,
    section_title VARCHAR(100) NOT NULL,
    max_marks INT NOT NULL,

    sequence_number INT NOT NULL,

    FOREIGN KEY (exam_id) REFERENCES exam(exam_id)
        ON DELETE CASCADE,

    UNIQUE (exam_id, sequence_number)
) ENGINE=InnoDB;
CREATE TABLE exam_attempt (
    attempt_id INT AUTO_INCREMENT PRIMARY KEY,

    exam_id INT NOT NULL,
    student_id INT NOT NULL,

    attempt_number INT NOT NULL DEFAULT 1,

    started_at DATETIME NULL,
    submitted_at DATETIME NULL,

    total_marks_obtained DECIMAL(6,2) NULL,

    status ENUM('registered','absent','submitted','evaluated','cancelled')
        NOT NULL DEFAULT 'registered',

    graded_by INT NULL,  -- examiner user_id
    graded_at DATETIME NULL,

    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT uq_exam_student_attempt
        UNIQUE (exam_id, student_id, attempt_number),

    FOREIGN KEY (exam_id) REFERENCES exam(exam_id)
        ON DELETE CASCADE,

    FOREIGN KEY (student_id) REFERENCES student(student_id)
        ON DELETE CASCADE,

    FOREIGN KEY (graded_by) REFERENCES `users`(id)
        ON DELETE SET NULL
) ENGINE=InnoDB;
CREATE TABLE exam_section_mark (
    attempt_id INT NOT NULL,
    section_id INT NOT NULL,

    marks_obtained DECIMAL(6,2) NOT NULL,

    PRIMARY KEY (attempt_id, section_id),

    FOREIGN KEY (attempt_id) REFERENCES exam_attempt(attempt_id)
        ON DELETE CASCADE,

    FOREIGN KEY (section_id) REFERENCES exam_section(section_id)
        ON DELETE CASCADE
) ENGINE=InnoDB;
CREATE TABLE exam_resource (
    exam_id INT NOT NULL,
    resource_id INT NOT NULL,

    PRIMARY KEY (exam_id, resource_id),

    FOREIGN KEY (exam_id) REFERENCES exam(exam_id)
        ON DELETE CASCADE,

    FOREIGN KEY (resource_id) REFERENCES resource(resource_id)
        ON DELETE CASCADE
) ENGINE=InnoDB;

CREATE TABLE attendance_session (
    session_id INT AUTO_INCREMENT PRIMARY KEY,
    lesson_id INT NOT NULL, -- FK to lesson

    session_date DATE NOT NULL,
    start_time TIME NULL,
    end_time TIME NULL,

    session_type ENUM('lecture','lab','practical','tutorial') NOT NULL DEFAULT 'lecture',
    status ENUM('scheduled','completed','cancelled') NOT NULL DEFAULT 'scheduled',

    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
        ON UPDATE CURRENT_TIMESTAMP,

    FOREIGN KEY (lesson_id) REFERENCES lesson(lesson_id)
        ON DELETE CASCADE
);

CREATE TABLE attendance_record (
    record_id INT AUTO_INCREMENT PRIMARY KEY,

    session_id INT NOT NULL,
    student_id INT NOT NULL,

    attendance_status ENUM('present','absent','late','excused') NOT NULL DEFAULT 'present',
    remarks VARCHAR(255) NULL,

    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
        ON UPDATE CURRENT_TIMESTAMP,

    CONSTRAINT uq_session_student UNIQUE (session_id, student_id),

    FOREIGN KEY (session_id) REFERENCES attendance_session(session_id)
        ON DELETE CASCADE,

    FOREIGN KEY (student_id) REFERENCES student(student_id)
        ON DELETE CASCADE
);


CREATE TABLE admission (
    admission_id INT AUTO_INCREMENT PRIMARY KEY,

    user_id INT NOT NULL,          -- applicant user
    program_id INT NOT NULL,       -- program applied to

    application_date DATE NOT NULL DEFAULT CURRENT_DATE,
    status ENUM('applied','under_review','accepted','rejected','deferred','withdrawn') 
        NOT NULL DEFAULT 'applied',

    applied_semester ENUM('spring','summer','fall') NULL,   -- optional
    admission_year YEAR NOT NULL,

    remarks TEXT NULL,             -- admin notes
    submitted_documents JSON NULL, -- optional list of documents

    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
        ON UPDATE CURRENT_TIMESTAMP,

    FOREIGN KEY (user_id) REFERENCES `users`(id)
        ON DELETE CASCADE,

    FOREIGN KEY (program_id) REFERENCES program(program_id)
        ON DELETE CASCADE
) ENGINE=InnoDB;
CREATE TABLE admission_document (
    admission_id INT NOT NULL,
    resource_id INT NOT NULL,

    PRIMARY KEY (admission_id, resource_id),

    FOREIGN KEY (admission_id) REFERENCES admission(admission_id)
        ON DELETE CASCADE,
    FOREIGN KEY (resource_id) REFERENCES resource(resource_id)
        ON DELETE CASCADE
) ENGINE=InnoDB;


CREATE TABLE invoice (
    invoice_id INT AUTO_INCREMENT PRIMARY KEY,
    
    student_id INT NOT NULL,          -- FK to student
    enrollment_id INT NULL,           -- optional link to specific course enrollment
    invoice_date DATE NOT NULL DEFAULT CURRENT_DATE,
    due_date DATE NOT NULL,
    
    total_amount DECIMAL(10,2) NOT NULL,
    status ENUM('pending','paid','partially_paid','overdue','cancelled') 
        NOT NULL DEFAULT 'pending',
    
    description TEXT NULL,
    
    created_by INT NULL,   -- admin user who created invoice
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
        ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (student_id) REFERENCES student(student_id)
        ON DELETE CASCADE,
    FOREIGN KEY (enrollment_id) REFERENCES enrollment(enrollment_id)
        ON DELETE SET NULL,
    FOREIGN KEY (created_by) REFERENCES `users`(id)
        ON DELETE SET NULL
) ENGINE=InnoDB;

CREATE TABLE payment (
    payment_id INT AUTO_INCREMENT PRIMARY KEY,
    
    invoice_id INT NOT NULL,
    
    payment_date DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    payment_method ENUM('cash','bank_transfer','card','online','cheque') NOT NULL,
    amount_paid DECIMAL(10,2) NOT NULL,
    payment_reference VARCHAR(100) NULL,  -- transaction number, cheque number, etc.
    
    received_by INT NULL,   -- staff user_id
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
        ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (invoice_id) REFERENCES invoice(invoice_id)
        ON DELETE CASCADE,
    FOREIGN KEY (received_by) REFERENCES `users`(id)
        ON DELETE SET NULL
) ENGINE=InnoDB;

CREATE TABLE fee_structure (
    program_id INT NOT NULL,
    fee_type ENUM('tuition','lab','library','sports','misc') NOT NULL,
    amount DECIMAL(10,2) NOT NULL,
    
    PRIMARY KEY (program_id, fee_type),
    FOREIGN KEY (program_id) REFERENCES program(program_id)
        ON DELETE CASCADE
) ENGINE=InnoDB;

CREATE TABLE notification (
    notification_id INT AUTO_INCREMENT PRIMARY KEY,
    
    title VARCHAR(150) NOT NULL,
    message TEXT NOT NULL,
    
    notification_type ENUM('info','warning','alert','assignment','exam','system') 
        NOT NULL DEFAULT 'info',
    
    is_general BOOLEAN NOT NULL DEFAULT FALSE,  -- true = all users
    scheduled_at DATETIME NULL,                 -- optional future delivery
    
    created_by INT NULL,                        -- staff/admin who created
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
        ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (created_by) REFERENCES `users`(id)
        ON DELETE SET NULL
) ENGINE=InnoDB;
CREATE TABLE user_notification (
    user_id INT NOT NULL,
    notification_id INT NOT NULL,
    
    is_read BOOLEAN NOT NULL DEFAULT FALSE,
    read_at DATETIME NULL,
    
    PRIMARY KEY (user_id, notification_id),
    
    FOREIGN KEY (user_id) REFERENCES `users`(id)
        ON DELETE CASCADE,
    
    FOREIGN KEY (notification_id) REFERENCES notification(notification_id)
        ON DELETE CASCADE
) ENGINE=InnoDB;
CREATE TABLE notification_resource (
    notification_id INT NOT NULL,
    resource_id INT NOT NULL,
    
    PRIMARY KEY (notification_id, resource_id),
    
    FOREIGN KEY (notification_id) REFERENCES notification(notification_id)
        ON DELETE CASCADE,
    
    FOREIGN KEY (resource_id) REFERENCES resource(resource_id)
        ON DELETE CASCADE
) ENGINE=InnoDB;
CREATE TABLE room (
    room_id INT AUTO_INCREMENT PRIMARY KEY,
    
    room_name VARCHAR(100) NOT NULL,
    room_type ENUM('classroom','lab','virtual','auditorium') NOT NULL DEFAULT 'classroom',
    location VARCHAR(150) NULL,
    capacity INT NOT NULL DEFAULT 0,
    status ENUM('active','inactive') NOT NULL DEFAULT 'active',
    
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
        ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB;
CREATE TABLE timetable (
    timetable_id INT AUTO_INCREMENT PRIMARY KEY,
    
    lesson_id INT NOT NULL,          -- FK to lesson
    room_id INT NOT NULL,            -- FK to room
    teacher_id INT NOT NULL,         -- FK to teacher (user_id)
    
    day_of_week ENUM('Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday') NOT NULL,
    start_time TIME NOT NULL,
    end_time TIME NOT NULL,
    
    recurrence ENUM('none','weekly') NOT NULL DEFAULT 'weekly', -- simple recurrence
    status ENUM('scheduled','cancelled','completed') NOT NULL DEFAULT 'scheduled',
    
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
        ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (lesson_id) REFERENCES lesson(lesson_id)
        ON DELETE CASCADE,
    FOREIGN KEY (room_id) REFERENCES room(room_id)
        ON DELETE CASCADE,
    FOREIGN KEY (teacher_id) REFERENCES teacher(teacher_id)
        ON DELETE CASCADE
) ENGINE=InnoDB;
CREATE TABLE room_availability (
    room_id INT NOT NULL,
    day_of_week ENUM('Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday') NOT NULL,
    start_time TIME NOT NULL,
    end_time TIME NOT NULL,
    
    PRIMARY KEY (room_id, day_of_week, start_time),
    FOREIGN KEY (room_id) REFERENCES room(room_id)
        ON DELETE CASCADE
) ENGINE=InnoDB;

CREATE TABLE certificate (
    certificate_id INT AUTO_INCREMENT PRIMARY KEY,

    student_id INT NOT NULL,          -- primary recipient
    program_id INT NULL,              -- optional
    course_id INT NULL,               -- optional

    certificate_type ENUM('course_completion','program_graduation','participation','honors') 
        NOT NULL DEFAULT 'course_completion',

    certificate_name VARCHAR(150) NOT NULL,
    issued_at DATE NOT NULL DEFAULT CURRENT_DATE,
    expiration_date DATE NULL,       -- optional for certification validity

    certificate_resource_id INT NULL, -- FK to resource table (PDF/Image)
    issued_by INT NULL,               -- users.id (staff/admin issuing)

    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
        ON UPDATE CURRENT_TIMESTAMP,

    FOREIGN KEY (student_id) REFERENCES student(student_id)
        ON DELETE CASCADE,
    FOREIGN KEY (program_id) REFERENCES program(program_id)
        ON DELETE SET NULL,
    FOREIGN KEY (course_id) REFERENCES course(course_id)
        ON DELETE SET NULL,
    FOREIGN KEY (certificate_resource_id) REFERENCES resource(resource_id)
        ON DELETE SET NULL,
    FOREIGN KEY (issued_by) REFERENCES users(id)
        ON DELETE SET NULL
) ENGINE=InnoDB;


CREATE TABLE forum (
    forum_id INT AUTO_INCREMENT PRIMARY KEY,
    
    course_id INT NOT NULL,
    module_id INT NULL,

    title VARCHAR(150) NOT NULL,
    description TEXT NULL,
    status ENUM('active','archived') NOT NULL DEFAULT 'active',

    created_by INT NULL,  -- allow NULL for deleted users
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
        ON UPDATE CURRENT_TIMESTAMP,

    FOREIGN KEY (course_id) REFERENCES course(course_id)
        ON DELETE CASCADE,
    FOREIGN KEY (module_id) REFERENCES module(module_id)
        ON DELETE SET NULL,
    FOREIGN KEY (created_by) REFERENCES users(id)
        ON DELETE SET NULL
) ENGINE=InnoDB;

CREATE TABLE forum_thread (
    thread_id INT AUTO_INCREMENT PRIMARY KEY,

    forum_id INT NOT NULL,           -- references forum.forum_id
    title VARCHAR(150) NOT NULL,
    created_by INT NULL,             -- references users.id, nullable for deleted users
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
        ON UPDATE CURRENT_TIMESTAMP,
    status ENUM('active','closed','archived') NOT NULL DEFAULT 'active',

    FOREIGN KEY (forum_id) REFERENCES forum(forum_id)
        ON DELETE CASCADE,
    FOREIGN KEY (created_by) REFERENCES users(id)
        ON DELETE SET NULL
) ENGINE=InnoDB;
CREATE TABLE forum_post (
    post_id INT AUTO_INCREMENT PRIMARY KEY,
    thread_id INT NOT NULL,
    parent_post_id INT NULL,
    posted_by INT NULL,
    content TEXT NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
        ON UPDATE CURRENT_TIMESTAMP,
    is_edited BOOLEAN NOT NULL DEFAULT FALSE,
    FOREIGN KEY (thread_id) REFERENCES forum_thread(thread_id) ON DELETE CASCADE,
    FOREIGN KEY (parent_post_id) REFERENCES forum_post(post_id) ON DELETE CASCADE,
    FOREIGN KEY (posted_by) REFERENCES users(id) ON DELETE SET NULL
) ENGINE=InnoDB;
CREATE TABLE forum_post_resource (
    post_id INT NOT NULL,
    resource_id INT NOT NULL,
    PRIMARY KEY (post_id, resource_id),

    FOREIGN KEY (post_id) REFERENCES forum_post(post_id)
        ON DELETE CASCADE,
    FOREIGN KEY (resource_id) REFERENCES resource(resource_id)
        ON DELETE CASCADE
) ENGINE=InnoDB;


CREATE TABLE permission (
    permission_id INT AUTO_INCREMENT PRIMARY KEY,
    permission_name VARCHAR(100) NOT NULL UNIQUE,
    description TEXT
) ENGINE=InnoDB;

-- Example usage for comment column (you can fill later):
-- 'manage_users' → "Admins can add, update, deactivate users"
-- 'submit_assignment' → "Students can submit assignments for enrolled courses"
-- 'grade_assignment' → "Faculty can grade student submissions"

CREATE TABLE roles_permissions (
    role_id INT NOT NULL,
    permission_id INT NOT NULL,
    PRIMARY KEY (role_id, permission_id),

    FOREIGN KEY (role_id) REFERENCES roles(role_id)
        ON DELETE CASCADE,
    FOREIGN KEY (permission_id) REFERENCES permission(permission_id)
        ON DELETE CASCADE
) ENGINE=InnoDB;
